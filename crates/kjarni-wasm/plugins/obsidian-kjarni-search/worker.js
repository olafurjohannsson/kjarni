(()=>{var D=class n{static __wrap(e){e=e>>>0;let t=Object.create(n.prototype);return t.__wbg_ptr=e,Q.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,Q.unregister(this),e}free(){let e=this.__destroy_into_raw();r.__wbg_wasmencoder_free(e,0)}encode_file(e,t){try{let i=r.__wbindgen_add_to_stack_pointer(-16),c=w(e,r.__wbindgen_export,r.__wbindgen_export2),u=d,g=w(t,r.__wbindgen_export,r.__wbindgen_export2),y=d;r.wasmencoder_encode_file(i,this.__wbg_ptr,c,u,g,y);var _=a().getInt32(i+4*0,!0),o=a().getInt32(i+4*1,!0),s=a().getInt32(i+4*2,!0);if(s)throw l(o);return l(_)}finally{r.__wbindgen_add_to_stack_pointer(16)}}static new(e){try{let s=r.__wbindgen_add_to_stack_pointer(-16),i=A(e,r.__wbindgen_export),c=d;r.wasmencoder_new(s,i,c);var t=a().getInt32(s+4*0,!0),_=a().getInt32(s+4*1,!0),o=a().getInt32(s+4*2,!0);if(o)throw l(_);return n.__wrap(t)}finally{r.__wbindgen_add_to_stack_pointer(16)}}};Symbol.dispose&&(D.prototype[Symbol.dispose]=D.prototype.free);var S=class n{static __wrap(e){e=e>>>0;let t=Object.create(n.prototype);return t.__wbg_ptr=e,X.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,X.unregister(this),e}free(){let e=this.__destroy_into_raw();r.__wbg_wasmindexbuilder_free(e,0)}add_chunk(e,t,_,o){try{let c=r.__wbindgen_add_to_stack_pointer(-16),u=w(e,r.__wbindgen_export,r.__wbindgen_export2),g=d,y=te(t,r.__wbindgen_export),m=d,O=w(_,r.__wbindgen_export,r.__wbindgen_export2),W=d;r.wasmindexbuilder_add_chunk(c,this.__wbg_ptr,u,g,y,m,O,W,o);var s=a().getInt32(c+4*0,!0),i=a().getInt32(c+4*1,!0);if(i)throw l(s)}finally{r.__wbindgen_add_to_stack_pointer(16)}}add_file(e,t){try{let i=r.__wbindgen_add_to_stack_pointer(-16),c=w(e,r.__wbindgen_export,r.__wbindgen_export2),u=d,g=w(t,r.__wbindgen_export,r.__wbindgen_export2),y=d;r.wasmindexbuilder_add_file(i,this.__wbg_ptr,c,u,g,y);var _=a().getInt32(i+4*0,!0),o=a().getInt32(i+4*1,!0),s=a().getInt32(i+4*2,!0);if(s)throw l(o);return _>>>0}finally{r.__wbindgen_add_to_stack_pointer(16)}}doc_count(){return r.wasmindexbuilder_doc_count(this.__wbg_ptr)>>>0}finish(){try{let i=r.__wbindgen_add_to_stack_pointer(-16);r.wasmindexbuilder_finish(i,this.__wbg_ptr);var e=a().getInt32(i+4*0,!0),t=a().getInt32(i+4*1,!0),_=a().getInt32(i+4*2,!0),o=a().getInt32(i+4*3,!0);if(o)throw l(_);var s=P(e,t).slice();return r.__wbindgen_export4(e,t*1,1),s}finally{r.__wbindgen_add_to_stack_pointer(16)}}static new(e){try{let s=r.__wbindgen_add_to_stack_pointer(-16),i=A(e,r.__wbindgen_export),c=d;r.wasmindexbuilder_new(s,i,c);var t=a().getInt32(s+4*0,!0),_=a().getInt32(s+4*1,!0),o=a().getInt32(s+4*2,!0);if(o)throw l(_);return n.__wrap(t)}finally{r.__wbindgen_add_to_stack_pointer(16)}}};Symbol.dispose&&(S.prototype[Symbol.dispose]=S.prototype.free);var L=class n{static __wrap(e){e=e>>>0;let t=Object.create(n.prototype);return t.__wbg_ptr=e,$.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,$.unregister(this),e}free(){let e=this.__destroy_into_raw();r.__wbg_wasmmodel_free(e,0)}encode(e,t){try{let u=r.__wbindgen_add_to_stack_pointer(-16),g=ne(e,r.__wbindgen_export),y=d;r.wasmmodel_encode(u,this.__wbg_ptr,g,y,t);var _=a().getInt32(u+4*0,!0),o=a().getInt32(u+4*1,!0),s=a().getInt32(u+4*2,!0),i=a().getInt32(u+4*3,!0);if(i)throw l(s);var c=ae(_,o).slice();return r.__wbindgen_export4(_,o*4,4),c}finally{r.__wbindgen_add_to_stack_pointer(16)}}static from_quantized(e){try{let s=r.__wbindgen_add_to_stack_pointer(-16),i=A(e,r.__wbindgen_export),c=d;r.wasmmodel_from_quantized(s,i,c);var t=a().getInt32(s+4*0,!0),_=a().getInt32(s+4*1,!0),o=a().getInt32(s+4*2,!0);if(o)throw l(_);return n.__wrap(t)}finally{r.__wbindgen_add_to_stack_pointer(16)}}static from_type(e){let t=r.wasmmodel_from_type(e);return l(t)}constructor(e,t,_){try{let c=r.__wbindgen_add_to_stack_pointer(-16),u=A(e,r.__wbindgen_export),g=d,y=w(t,r.__wbindgen_export,r.__wbindgen_export2),m=d,O=w(_,r.__wbindgen_export,r.__wbindgen_export2),W=d;r.wasmmodel_new(c,u,g,y,m,O,W);var o=a().getInt32(c+4*0,!0),s=a().getInt32(c+4*1,!0),i=a().getInt32(c+4*2,!0);if(i)throw l(s);return this.__wbg_ptr=o>>>0,$.register(this,this.__wbg_ptr,this),this}finally{r.__wbindgen_add_to_stack_pointer(16)}}};Symbol.dispose&&(L.prototype[Symbol.dispose]=L.prototype.free);var Ae=Object.freeze({MiniLML6V2:0,0:"MiniLML6V2"}),R=class n{static __wrap(e){e=e>>>0;let t=Object.create(n.prototype);return t.__wbg_ptr=e,Y.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,Y.unregister(this),e}free(){let e=this.__destroy_into_raw();r.__wbg_wasmreranker_free(e,0)}static load(e){try{let s=r.__wbindgen_add_to_stack_pointer(-16),i=A(e,r.__wbindgen_export),c=d;r.wasmreranker_load(s,i,c);var t=a().getInt32(s+4*0,!0),_=a().getInt32(s+4*1,!0),o=a().getInt32(s+4*2,!0);if(o)throw l(_);return n.__wrap(t)}finally{r.__wbindgen_add_to_stack_pointer(16)}}rerank(e,t,_){try{let c=r.__wbindgen_add_to_stack_pointer(-16),u=w(e,r.__wbindgen_export,r.__wbindgen_export2),g=d,y=ne(t,r.__wbindgen_export),m=d;r.wasmreranker_rerank(c,this.__wbg_ptr,u,g,y,m,_);var o=a().getInt32(c+4*0,!0),s=a().getInt32(c+4*1,!0),i=a().getInt32(c+4*2,!0);if(i)throw l(s);return l(o)}finally{r.__wbindgen_add_to_stack_pointer(16)}}score(e,t){try{let i=r.__wbindgen_add_to_stack_pointer(-16),c=w(e,r.__wbindgen_export,r.__wbindgen_export2),u=d,g=w(t,r.__wbindgen_export,r.__wbindgen_export2),y=d;r.wasmreranker_score(i,this.__wbg_ptr,c,u,g,y);var _=a().getFloat32(i+4*0,!0),o=a().getInt32(i+4*1,!0),s=a().getInt32(i+4*2,!0);if(s)throw l(o);return _}finally{r.__wbindgen_add_to_stack_pointer(16)}}};Symbol.dispose&&(R.prototype[Symbol.dispose]=R.prototype.free);var v=class n{static __wrap(e){e=e>>>0;let t=Object.create(n.prototype);return t.__wbg_ptr=e,K.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,K.unregister(this),e}free(){let e=this.__destroy_into_raw();r.__wbg_wasmsearch_free(e,0)}add_chunk(e,t,_,o){try{let c=r.__wbindgen_add_to_stack_pointer(-16),u=w(e,r.__wbindgen_export,r.__wbindgen_export2),g=d,y=te(t,r.__wbindgen_export),m=d,O=w(_,r.__wbindgen_export,r.__wbindgen_export2),W=d;r.wasmindexbuilder_add_chunk(c,this.__wbg_ptr,u,g,y,m,O,W,o);var s=a().getInt32(c+4*0,!0),i=a().getInt32(c+4*1,!0);if(i)throw l(s)}finally{r.__wbindgen_add_to_stack_pointer(16)}}doc_count(){return r.wasmindexbuilder_doc_count(this.__wbg_ptr)>>>0}static load(e,t){try{let i=r.__wbindgen_add_to_stack_pointer(-16),c=A(e,r.__wbindgen_export),u=d,g=A(t,r.__wbindgen_export),y=d;r.wasmsearch_load(i,c,u,g,y);var _=a().getInt32(i+4*0,!0),o=a().getInt32(i+4*1,!0),s=a().getInt32(i+4*2,!0);if(s)throw l(o);return n.__wrap(_)}finally{r.__wbindgen_add_to_stack_pointer(16)}}remove_file(e){let t=w(e,r.__wbindgen_export,r.__wbindgen_export2),_=d;return r.wasmsearch_remove_file(this.__wbg_ptr,t,_)>>>0}save_index(){try{let i=r.__wbindgen_add_to_stack_pointer(-16);r.wasmindexbuilder_finish(i,this.__wbg_ptr);var e=a().getInt32(i+4*0,!0),t=a().getInt32(i+4*1,!0),_=a().getInt32(i+4*2,!0),o=a().getInt32(i+4*3,!0);if(o)throw l(_);var s=P(e,t).slice();return r.__wbindgen_export4(e,t*1,1),s}finally{r.__wbindgen_add_to_stack_pointer(16)}}search(e,t){try{let i=r.__wbindgen_add_to_stack_pointer(-16),c=w(e,r.__wbindgen_export,r.__wbindgen_export2),u=d;r.wasmsearch_search(i,this.__wbg_ptr,c,u,t);var _=a().getInt32(i+4*0,!0),o=a().getInt32(i+4*1,!0),s=a().getInt32(i+4*2,!0);if(s)throw l(o);return l(_)}finally{r.__wbindgen_add_to_stack_pointer(16)}}search_keywords(e,t){try{let i=r.__wbindgen_add_to_stack_pointer(-16),c=w(e,r.__wbindgen_export,r.__wbindgen_export2),u=d;r.wasmsearch_search_keywords(i,this.__wbg_ptr,c,u,t);var _=a().getInt32(i+4*0,!0),o=a().getInt32(i+4*1,!0),s=a().getInt32(i+4*2,!0);if(s)throw l(o);return l(_)}finally{r.__wbindgen_add_to_stack_pointer(16)}}search_semantic(e,t){try{let i=r.__wbindgen_add_to_stack_pointer(-16),c=w(e,r.__wbindgen_export,r.__wbindgen_export2),u=d;r.wasmsearch_search_semantic(i,this.__wbg_ptr,c,u,t);var _=a().getInt32(i+4*0,!0),o=a().getInt32(i+4*1,!0),s=a().getInt32(i+4*2,!0);if(s)throw l(o);return l(_)}finally{r.__wbindgen_add_to_stack_pointer(16)}}update_file(e,t){try{let i=r.__wbindgen_add_to_stack_pointer(-16),c=w(e,r.__wbindgen_export,r.__wbindgen_export2),u=d,g=w(t,r.__wbindgen_export,r.__wbindgen_export2),y=d;r.wasmsearch_update_file(i,this.__wbg_ptr,c,u,g,y);var _=a().getInt32(i+4*0,!0),o=a().getInt32(i+4*1,!0),s=a().getInt32(i+4*2,!0);if(s)throw l(o);return _>>>0}finally{r.__wbindgen_add_to_stack_pointer(16)}}};Symbol.dispose&&(v.prototype[Symbol.dispose]=v.prototype.free);function _e(){return{__proto__:null,"./kjarni_wasm_bg.js":{__proto__:null,__wbg_Error_8c4e43fe74559d73:function(e,t){let _=Error(k(e,t));return b(_)},__wbg_String_8f0eb39a4a4c2f66:function(e,t){let _=String(f(t)),o=w(_,r.__wbindgen_export,r.__wbindgen_export2),s=d;a().setInt32(e+4,s,!0),a().setInt32(e+0,o,!0)},__wbg___wbindgen_debug_string_0bc8482c6e3508ae:function(e,t){let _=G(f(t)),o=w(_,r.__wbindgen_export,r.__wbindgen_export2),s=d;a().setInt32(e+4,s,!0),a().setInt32(e+0,o,!0)},__wbg___wbindgen_is_function_0095a73b8b156f76:function(e){return typeof f(e)=="function"},__wbg___wbindgen_is_string_cd444516edc5b180:function(e){return typeof f(e)=="string"},__wbg___wbindgen_is_undefined_9e4d92534c42d778:function(e){return f(e)===void 0},__wbg___wbindgen_string_get_72fb696202c56729:function(e,t){let _=f(t),o=typeof _=="string"?_:void 0;var s=B(o)?0:w(o,r.__wbindgen_export,r.__wbindgen_export2),i=d;a().setInt32(e+4,i,!0),a().setInt32(e+0,s,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,t){throw new Error(k(e,t))},__wbg__wbg_cb_unref_d9b87ff7982e3b21:function(e){f(e)._wbg_cb_unref()},__wbg_arrayBuffer_bb54076166006c39:function(){return N(function(e){let t=f(e).arrayBuffer();return b(t)},arguments)},__wbg_call_389efe28435a9388:function(){return N(function(e,t){let _=f(e).call(f(t));return b(_)},arguments)},__wbg_call_4708e0c13bdc8e95:function(){return N(function(e,t,_){let o=f(e).call(f(t),f(_));return b(o)},arguments)},__wbg_error_7534b8e9a36f1ab4:function(e,t){let _,o;try{_=e,o=t,console.error(k(e,t))}finally{r.__wbindgen_export4(_,o,1)}},__wbg_fetch_4f06ca81d87798ba:function(e,t,_){let o=f(e).fetch(k(t,_));return b(o)},__wbg_fetch_d1488f40cef1e210:function(e,t,_){let o=f(e).fetch(k(t,_));return b(o)},__wbg_instanceof_Response_ee1d54d79ae41977:function(e){let t;try{t=f(e)instanceof Response}catch(o){t=!1}return t},__wbg_instanceof_Window_ed49b2db8df90359:function(e){let t;try{t=f(e)instanceof Window}catch(o){t=!1}return t},__wbg_instanceof_WorkerGlobalScope_07b9d5514ff0156e:function(e){let t;try{t=f(e)instanceof WorkerGlobalScope}catch(o){t=!1}return t},__wbg_length_32ed9a279acd054c:function(e){return f(e).length},__wbg_new_361308b2356cecd0:function(){let e=new Object;return b(e)},__wbg_new_3eb36ae241fe6f44:function(){let e=new Array;return b(e)},__wbg_new_8a6f238a6ece86ea:function(){let e=new Error;return b(e)},__wbg_new_b5d9e2fb389fef91:function(e,t){try{var _={a:e,b:t},o=(i,c)=>{let u=_.a;_.a=0;try{return ie(u,_.b,i,c)}finally{_.a=u}};let s=new Promise(o);return b(s)}finally{_.a=_.b=0}},__wbg_new_dca287b076112a51:function(){return b(new Map)},__wbg_new_dd2b680c8bf6ae29:function(e){let t=new Uint8Array(f(e));return b(t)},__wbg_new_no_args_1c7c842f08d00ebb:function(e,t){let _=new Function(k(e,t));return b(_)},__wbg_prototypesetcall_bdcdcc5842e4d77d:function(e,t,_){Uint8Array.prototype.set.call(P(e,t),f(_))},__wbg_queueMicrotask_0aa0a927f78f5d98:function(e){let t=f(e).queueMicrotask;return b(t)},__wbg_queueMicrotask_5bb536982f78a56f:function(e){queueMicrotask(f(e))},__wbg_resolve_002c4b7d9d8f6b64:function(e){let t=Promise.resolve(f(e));return b(t)},__wbg_set_1eb0999cf5d27fc8:function(e,t,_){let o=f(e).set(f(t),f(_));return b(o)},__wbg_set_3f1d0b984ed272ed:function(e,t,_){f(e)[l(t)]=l(_)},__wbg_set_f43e577aea94465b:function(e,t,_){f(e)[t>>>0]=l(_)},__wbg_stack_0ed75d68575b0f3c:function(e,t){let _=f(t).stack,o=w(_,r.__wbindgen_export,r.__wbindgen_export2),s=d;a().setInt32(e+4,s,!0),a().setInt32(e+0,o,!0)},__wbg_static_accessor_GLOBAL_12837167ad935116:function(){let e=typeof global=="undefined"?null:global;return B(e)?0:b(e)},__wbg_static_accessor_GLOBAL_THIS_e628e89ab3b1c95f:function(){let e=typeof globalThis=="undefined"?null:globalThis;return B(e)?0:b(e)},__wbg_static_accessor_SELF_a621d3dfbb60d0ce:function(){let e=typeof self=="undefined"?null:self;return B(e)?0:b(e)},__wbg_static_accessor_WINDOW_f8727f0cf888e0bd:function(){let e=typeof window=="undefined"?null:window;return B(e)?0:b(e)},__wbg_text_083b8727c990c8c0:function(){return N(function(e){let t=f(e).text();return b(t)},arguments)},__wbg_then_0d9fe2c7b1857d32:function(e,t,_){let o=f(e).then(f(t),f(_));return b(o)},__wbg_then_b9e7b3b5f1a9e1b5:function(e,t){let _=f(e).then(f(t));return b(_)},__wbg_wasmmodel_new:function(e){let t=L.__wrap(e);return b(t)},__wbindgen_cast_0000000000000001:function(e,t){let _=ce(e,t,r.__wasm_bindgen_func_elem_821,oe);return b(_)},__wbindgen_cast_0000000000000002:function(e){return b(e)},__wbindgen_cast_0000000000000003:function(e,t){let _=k(e,t);return b(_)},__wbindgen_cast_0000000000000004:function(e){let t=BigInt.asUintN(64,e);return b(t)},__wbindgen_object_clone_ref:function(e){let t=f(e);return b(t)},__wbindgen_object_drop_ref:function(e){l(e)}}}}function oe(n,e,t){r.__wasm_bindgen_func_elem_822(n,e,b(t))}function ie(n,e,t,_){r.__wasm_bindgen_func_elem_869(n,e,b(t),b(_))}var Q=typeof FinalizationRegistry=="undefined"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>r.__wbg_wasmencoder_free(n>>>0,1)),X=typeof FinalizationRegistry=="undefined"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>r.__wbg_wasmindexbuilder_free(n>>>0,1)),$=typeof FinalizationRegistry=="undefined"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>r.__wbg_wasmmodel_free(n>>>0,1)),Y=typeof FinalizationRegistry=="undefined"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>r.__wbg_wasmreranker_free(n>>>0,1)),K=typeof FinalizationRegistry=="undefined"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>r.__wbg_wasmsearch_free(n>>>0,1));function b(n){T===x.length&&x.push(x.length+1);let e=T;return T=x[e],x[e]=n,e}var Z=typeof FinalizationRegistry=="undefined"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>n.dtor(n.a,n.b));function G(n){let e=typeof n;if(e=="number"||e=="boolean"||n==null)return`${n}`;if(e=="string")return`"${n}"`;if(e=="symbol"){let o=n.description;return o==null?"Symbol":`Symbol(${o})`}if(e=="function"){let o=n.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(n)){let o=n.length,s="[";o>0&&(s+=G(n[0]));for(let i=1;i<o;i++)s+=", "+G(n[i]);return s+="]",s}let t=/\[object ([^\]]+)\]/.exec(toString.call(n)),_;if(t&&t.length>1)_=t[1];else return toString.call(n);if(_=="Object")try{return"Object("+JSON.stringify(n)+")"}catch(o){return"Object"}return n instanceof Error?`${n.name}: ${n.message}
${n.stack}`:_}function se(n){n<132||(x[n]=T,T=n)}function ae(n,e){return n=n>>>0,ee().subarray(n/4,n/4+e)}function P(n,e){return n=n>>>0,F().subarray(n/1,n/1+e)}var I=null;function a(){return(I===null||I.buffer.detached===!0||I.buffer.detached===void 0&&I.buffer!==r.memory.buffer)&&(I=new DataView(r.memory.buffer)),I}var z=null;function ee(){return(z===null||z.byteLength===0)&&(z=new Float32Array(r.memory.buffer)),z}function k(n,e){return n=n>>>0,ue(n,e)}var E=null;function F(){return(E===null||E.byteLength===0)&&(E=new Uint8Array(r.memory.buffer)),E}function f(n){return x[n]}function N(n,e){try{return n.apply(this,e)}catch(t){r.__wbindgen_export3(b(t))}}var x=new Array(128).fill(void 0);x.push(void 0,null,!0,!1);var T=x.length;function B(n){return n==null}function ce(n,e,t,_){let o={a:n,b:e,cnt:1,dtor:t},s=(...i)=>{o.cnt++;let c=o.a;o.a=0;try{return _(c,o.b,...i)}finally{o.a=c,s._wbg_cb_unref()}};return s._wbg_cb_unref=()=>{--o.cnt===0&&(o.dtor(o.a,o.b),o.a=0,Z.unregister(o))},Z.register(s,o,o),s}function A(n,e){let t=e(n.length*1,1)>>>0;return F().set(n,t/1),d=n.length,t}function te(n,e){let t=e(n.length*4,4)>>>0;return ee().set(n,t/4),d=n.length,t}function ne(n,e){let t=e(n.length*4,4)>>>0,_=a();for(let o=0;o<n.length;o++)_.setUint32(t+4*o,b(n[o]),!0);return d=n.length,t}function w(n,e,t){if(t===void 0){let c=U.encode(n),u=e(c.length,1)>>>0;return F().subarray(u,u+c.length).set(c),d=c.length,u}let _=n.length,o=e(_,1)>>>0,s=F(),i=0;for(;i<_;i++){let c=n.charCodeAt(i);if(c>127)break;s[o+i]=c}if(i!==_){i!==0&&(n=n.slice(i)),o=t(o,_,_=i+n.length*3,1)>>>0;let c=F().subarray(o+i,o+_),u=U.encodeInto(n,c);i+=u.written,o=t(o,_,i,1)>>>0}return d=i,o}function l(n){let e=f(n);return se(n),e}var q=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});q.decode();var de=2146435072,V=0;function ue(n,e){return V+=e,V>=de&&(q=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),q.decode(),V=e),q.decode(F().subarray(n,n+e))}var U=new TextEncoder;"encodeInto"in U||(U.encodeInto=function(n,e){let t=U.encode(n);return e.set(t),{read:n.length,written:t.length}});var d=0,fe,r;function be(n,e){return r=n.exports,fe=e,I=null,z=null,E=null,r.__wbindgen_start(),r}async function le(n,e){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,e)}catch(o){if(n.ok&&t(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}let _=await n.arrayBuffer();return await WebAssembly.instantiate(_,e)}else{let _=await WebAssembly.instantiate(n,e);return _ instanceof WebAssembly.Instance?{instance:_,module:n}:_}function t(_){switch(_){case"basic":case"cors":case"default":return!0}return!1}}async function re(n){if(r!==void 0)return r;n!==void 0&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),n===void 0&&(n=new URL("kjarni_wasm_bg.wasm",""));let e=_e();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));let{instance:t,module:_}=await le(await n,e);return be(t,_)}var h=null,C=null,j=null,M=null;function p(n,e){e?self.postMessage(n,e):self.postMessage(n)}var H=!1,J=[];self.onmessage=n=>{J.push(n),we()};async function we(){if(!H){for(H=!0;J.length>0;){let e=J.shift().data;try{switch(e.type){case"init":await pe(e);break;case"build_start":ge(e);break;case"add_encoded_chunks":ye(e);break;case"build_finish":he(e);break;case"search":xe(e);break;case"rerank":me(e);break;case"update_file":ke(e);break;case"remove_file":Ie(e);break;case"save_index":ve(e);break;default:p({type:"error",id:e.id,error:`Unknown: ${e.type}`})}}catch(t){p({type:"error",id:e.id,error:t.message||String(t)})}}H=!1}}async function pe(n){if(await re(n.wasmBytes),M=new Uint8Array(n.encoderBytes),n.rerankerBytes)try{C=R.load(new Uint8Array(n.rerankerBytes))}catch(e){console.error("Worker: Failed to load reranker:",e)}if(n.indexBytes)try{h=v.load(M,new Uint8Array(n.indexBytes)),p({type:"init_done",id:n.id,hasIndex:!0,docCount:h.doc_count(),hasReranker:C!==null});return}catch(e){console.error("Worker: Failed to load index:",e)}p({type:"init_done",id:n.id,hasIndex:!1,docCount:0,hasReranker:C!==null})}function ge(n){if(!M){p({type:"error",id:n.id,error:"No encoder loaded"});return}j=S.new(M),p({type:"build_started",id:n.id})}function ye(n){if(!j){p({type:"error",id:n.id,error:"No builder \u2014 call build_start first"});return}let e=n.chunks,t=0;for(let _ of e)try{j.add_chunk(_.text,new Float32Array(_.embedding),_.source,_.chunk_index),t++}catch(o){console.warn(`Worker: Failed to add chunk from ${_.source}: ${o}`)}p({type:"chunks_added",id:n.id,added:t})}function he(n){if(!j||!M){p({type:"error",id:n.id,error:"No builder or encoder"});return}let e=j.finish();h=v.load(M,new Uint8Array(e)),j=null;let t=e.buffer||e;p({type:"build_done",id:n.id,docCount:h.doc_count(),indexBytes:e},[t])}function xe(n){if(!h){p({type:"search_result",id:n.id,results:[]});return}let t=h.search(n.query,n.limit||20).map(_=>{let o=_.metadata instanceof Map?Object.fromEntries(_.metadata):_.metadata||{};return{score:_.score,text:_.text,source:o.source||"unknown",metadata:o}});p({type:"search_result",id:n.id,results:t})}function me(n){if(!C){p({type:"rerank_result",id:n.id,results:[]});return}let t=C.rerank(n.query,n.docs,n.limit||5).map(_=>({index:_.index,score:_.score,text:_.text}));p({type:"rerank_result",id:n.id,results:t})}function ke(n){if(!h){p({type:"error",id:n.id,error:"No search index loaded"});return}let e=0;try{e=h.update_file(n.text,n.path)}catch(t){p({type:"error",id:n.id,error:`Update failed: ${t}`});return}p({type:"file_updated",id:n.id,path:n.path,chunks:e,docCount:h.doc_count()})}function Ie(n){if(!h){p({type:"error",id:n.id,error:"No search index loaded"});return}let e=h.remove_file(n.path);p({type:"file_removed",id:n.id,path:n.path,removed:e,docCount:h.doc_count()})}function ve(n){if(!h){p({type:"error",id:n.id,error:"No search index to save"});return}let e=h.save_index(),t=e.buffer||e;p({type:"index_saved",id:n.id,docCount:h.doc_count(),indexBytes:e},[t])}})();
