var $=Object.create;var S=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var I=Object.getPrototypeOf,L=Object.prototype.hasOwnProperty;var P=(r,a)=>{for(var e in a)S(r,e,{get:a[e],enumerable:!0})},F=(r,a,e,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let n of B(a))!L.call(r,n)&&n!==e&&S(r,n,{get:()=>a[n],enumerable:!(t=M(a,n))||t.enumerable});return r};var T=(r,a,e)=>(e=r!=null?$(I(r)):{},F(a||!r||!r.__esModule?S(e,"default",{value:r,enumerable:!0}):e,r)),A=r=>F(S({},"__esModule",{value:!0}),r);var _={};P(_,{default:()=>E});module.exports=A(_);var s=require("obsidian"),o=T(require("fs")),u=T(require("path")),D={chunkSize:1e3,chunkOverlap:200,searchLimit:10,rerankerEnabled:!0},w=null;function C(r){if(w)return w;let a=u.join(r,"pkg","kjarni_wasm.js");return w=require(a),w}var E=class extends s.Plugin{constructor(){super(...arguments);this.settings=D;this.pluginDir="";this.wasm=null;this.search=null;this.reranker=null;this.indexReady=!1;this.indexing=!1;this.fileHashes=new Map;this.statusBarEl=null;this.debouncedReindexFile=(0,s.debounce)(e=>{console.log(`Kjarni: File modified: ${e.path} (index may be stale)`)},5e3,!0);this.scheduleFullReindex=(0,s.debounce)(()=>{this.indexReady&&new s.Notice("Kjarni: File deleted. Reindex recommended (Cmd+P \u2192 Kjarni: Reindex vault)")},1e4,!0)}async onload(){await this.loadSettings(),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.setText("");let e=this.app.vault.adapter.basePath;this.pluginDir=u.join(e,".obsidian","plugins","kjarni-search"),this.addCommand({id:"open-search",name:"Search vault",callback:()=>this.openSearch(),hotkeys:[{modifiers:["Mod","Shift"],key:"k"}]}),this.addCommand({id:"reindex-vault",name:"Reindex vault",callback:()=>this.reindexVault()}),this.addRibbonIcon("search","Kjarni Search",()=>this.openSearch()),this.addSettingTab(new R(this.app,this)),this.initializeAsync(),this.registerEvent(this.app.vault.on("modify",t=>{t instanceof s.TFile&&t.extension==="md"&&this.debouncedReindexFile(t)})),this.registerEvent(this.app.vault.on("create",t=>{t instanceof s.TFile&&t.extension==="md"&&this.debouncedReindexFile(t)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof s.TFile&&t.extension==="md"&&this.scheduleFullReindex()}))}onunload(){this.search=null,this.reranker=null,w=null}async initializeAsync(){try{if(!this.checkFiles())return;if(new s.Notice("Kjarni: Loading search engine..."),this.wasm=C(this.pluginDir),this.settings.rerankerEnabled){let t=u.join(this.pluginDir,"models","reranker.kjq");if(o.existsSync(t)){let n=o.readFileSync(t);this.reranker=this.wasm.WasmReranker.load(new Uint8Array(n))}}let e=u.join(this.pluginDir,"index.idx");o.existsSync(e)?await this.loadExistingIndex(e):await this.buildFullIndex()}catch(e){console.error("Kjarni: Initialization failed:",e),new s.Notice(`Kjarni: Failed to initialize \u2014 ${e}`)}}checkFiles(){let e=u.join(this.pluginDir,"pkg","kjarni_wasm.js"),t=u.join(this.pluginDir,"pkg","kjarni_wasm_bg.wasm"),n=u.join(this.pluginDir,"models","encoder.kjq"),i=[];return o.existsSync(e)||i.push("pkg/kjarni_wasm.js"),o.existsSync(t)||i.push("pkg/kjarni_wasm_bg.wasm"),o.existsSync(n)||i.push("models/encoder.kjq"),i.length>0?(new s.Notice(`Kjarni: Missing files in plugin directory:
${i.join(`
`)}

See plugin README for setup instructions.`,1e4),!1):!0}async loadExistingIndex(e){try{let t=o.readFileSync(e),n=o.readFileSync(u.join(this.pluginDir,"models","encoder.kjq"));this.search=this.wasm.WasmSearch.load(new Uint8Array(n),new Uint8Array(t)),this.indexReady=!0,new s.Notice(`Kjarni: Loaded index (${this.search.doc_count()} chunks)`),await this.incrementalUpdate(e)}catch(t){console.error("Kjarni: Failed to load index, rebuilding:",t),await this.buildFullIndex()}}async buildFullIndex(){var e,t,n;if(!this.indexing){this.indexing=!0;try{let i=u.join(this.pluginDir,"models","encoder.kjq"),c=o.readFileSync(i),l=this.wasm.WasmIndexBuilder.new(new Uint8Array(c)),d=this.app.vault.getMarkdownFiles().sort((m,j)=>m.path.localeCompare(j.path)),h=d.length,p=0,g=0;(e=this.statusBarEl)==null||e.setText(`Kjarni: indexing 0/${h}...`);let f=Date.now();for(let m of d){let j=await this.app.vault.cachedRead(m);if(j.trim().length!==0){try{let k=l.add_file(j,m.path);g+=k}catch(k){console.warn(`Kjarni: Skipped ${m.path}: ${k}`)}if(p++,p%10===0){let k=((Date.now()-f)/1e3).toFixed(0),K=(p/(Date.now()-f)*1e3).toFixed(1);(t=this.statusBarEl)==null||t.setText(`Kjarni: ${p}/${h} files (${g} chunks) \xB7 ${k}s \xB7 ${K} files/s`),await U(0)}}}let x=l.finish(),y=u.join(this.pluginDir,"index.idx");o.writeFileSync(y,Buffer.from(x)),this.search=this.wasm.WasmSearch.load(new Uint8Array(c),new Uint8Array(x)),this.indexReady=!0;for(let m of d)this.fileHashes.set(m.path,m.stat.mtime);let v=((Date.now()-f)/1e3).toFixed(1);(n=this.statusBarEl)==null||n.setText(`Kjarni: ${g} chunks \xB7 ${p} files \xB7 ${v}s`),new s.Notice(`Kjarni: Indexed ${g} chunks from ${p} files in ${v}s`)}catch(i){console.error("Kjarni: Indexing failed:",i),new s.Notice(`Kjarni: Indexing failed \u2014 ${i}`)}finally{this.indexing=!1}}}async incrementalUpdate(e){let n=o.statSync(e).mtimeMs,i=this.app.vault.getMarkdownFiles().filter(c=>c.stat.mtime>n);if(i.length>0){let c=this.app.vault.getMarkdownFiles().length;i.length>c*.2?(new s.Notice(`Kjarni: ${i.length} files changed, rebuilding index...`),await this.buildFullIndex()):new s.Notice(`Kjarni: ${i.length} files changed since last index. Use "Reindex vault" to update.`)}}async reindexVault(){if(this.indexing){new s.Notice("Kjarni: Already indexing...");return}await this.buildFullIndex()}openSearch(){if(!this.indexReady){new s.Notice("Kjarni: Search index not ready yet. Please wait for indexing to complete.");return}new b(this.app,this).open()}doSearch(e){if(!this.search||!e.trim())return[];try{return this.search.search(e,this.settings.searchLimit*2)}catch(t){return console.error("Kjarni: Search failed:",t),[]}}doRerank(e,t){if(!this.reranker||t.length===0)return t.map((n,i)=>({index:i,score:n.score,text:n.text}));try{let n=t.map(i=>i.text);return this.reranker.rerank(e,n,this.settings.searchLimit)}catch(n){return console.error("Kjarni: Rerank failed:",n),t.map((i,c)=>({index:c,score:i.score,text:i.text}))}}async loadSettings(){this.settings=Object.assign({},D,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},b=class extends s.Modal{constructor(e,t){super(e);this.inputEl=null;this.resultsEl=null;this.debounceTimer=null;this.lastResults=[];this.plugin=t}onOpen(){let{contentEl:e,modalEl:t}=this;t.addClass("kjarni-search-modal");let n=e.createDiv({cls:"kjarni-header"}),i=n.createEl("span",{cls:"kjarni-icon"});i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',this.inputEl=n.createEl("input",{cls:"kjarni-input",attr:{type:"text",placeholder:"Search your vault...",spellcheck:"false"}}),n.createEl("span",{cls:"kjarni-kbd"}).setText("esc"),this.resultsEl=e.createDiv({cls:"kjarni-results"}),e.createDiv({cls:"kjarni-status"}),this.inputEl.addEventListener("input",()=>{this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>this.runSearch(),150)}),this.inputEl.addEventListener("keydown",l=>{l.key==="Escape"?this.close():l.key==="Enter"&&this.openResult(0)}),this.inputEl.focus()}runSearch(){var h,p;let e=(p=(h=this.inputEl)==null?void 0:h.value)==null?void 0:p.trim();if(!e||!this.resultsEl){this.resultsEl&&this.resultsEl.empty();return}let t=performance.now(),n=this.plugin.doSearch(e),i=performance.now()-t,c=performance.now(),l=this.plugin.doRerank(e,n),d=performance.now()-c;this.lastResults=n,this.renderResults(l,n,i,d)}renderResults(e,t,n,i){if(!this.resultsEl)return;if(this.resultsEl.empty(),e.length===0){this.resultsEl.createDiv({cls:"kjarni-empty",text:"No results found"});return}e.forEach((l,d)=>{let h=t[l.index],g=((h==null?void 0:h.metadata)instanceof Map?h.metadata:new Map).get("source")||"unknown",f=l.text.length>200?l.text.slice(0,200)+"...":l.text,x=this.resultsEl.createDiv({cls:"kjarni-result"});x.addEventListener("click",()=>this.openResult(d));let y=x.createDiv({cls:"kjarni-result-title"});y.createEl("span",{text:g.replace(/\.md$/,"")}),y.createEl("span",{cls:"kjarni-score",text:l.score.toFixed(3)}),x.createDiv({cls:"kjarni-result-text",text:f})});let c=this.contentEl.querySelector(".kjarni-status");c&&(c.textContent=`${e.length} results \xB7 ${n.toFixed(0)}ms search \xB7 ${i.toFixed(0)}ms rerank`)}openResult(e){var d;let n=this.plugin.doRerank(((d=this.inputEl)==null?void 0:d.value)||"",this.lastResults)[e];if(!n)return;let i=this.lastResults[n.index],l=((i==null?void 0:i.metadata)instanceof Map?i.metadata:new Map).get("source");l&&this.app.vault.getAbstractFileByPath(l)instanceof s.TFile&&(this.app.workspace.openLinkText(l,"",!1),this.close())}onClose(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.contentEl.empty()}},R=class extends s.PluginSettingTab{constructor(a,e){super(a,e),this.plugin=e}display(){let{containerEl:a}=this;a.empty(),a.createEl("h2",{text:"Kjarni Search"}),this.plugin.indexReady&&this.plugin.search&&a.createEl("p",{text:`Index: ${this.plugin.search.doc_count()} chunks indexed`,cls:"setting-item-description"}),new s.Setting(a).setName("Search results limit").setDesc("Maximum number of results to show").addSlider(e=>e.setLimits(5,30,5).setValue(this.plugin.settings.searchLimit).setDynamicTooltip().onChange(async t=>{this.plugin.settings.searchLimit=t,await this.plugin.saveSettings()})),new s.Setting(a).setName("Reranker").setDesc("Use cross-encoder reranking for better result quality (requires reranker.kjq model)").addToggle(e=>e.setValue(this.plugin.settings.rerankerEnabled).onChange(async t=>{this.plugin.settings.rerankerEnabled=t,await this.plugin.saveSettings()})),new s.Setting(a).setName("Chunk size").setDesc("Maximum characters per chunk when indexing (default 1000)").addText(e=>e.setValue(String(this.plugin.settings.chunkSize)).onChange(async t=>{let n=parseInt(t);!isNaN(n)&&n>100&&(this.plugin.settings.chunkSize=n,await this.plugin.saveSettings())})),new s.Setting(a).setName("Reindex vault").setDesc("Rebuild the search index from scratch").addButton(e=>e.setButtonText("Reindex").onClick(async()=>{await this.plugin.reindexVault()}))}};function U(r){return new Promise(a=>setTimeout(a,r))}
