var H=Object.create;var b=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var X=(u,c)=>{for(var e in c)b(u,e,{get:c[e],enumerable:!0})},L=(u,c,e,t)=>{if(c&&typeof c=="object"||typeof c=="function")for(let s of J(c))!Q.call(u,s)&&s!==e&&b(u,s,{get:()=>c[s],enumerable:!(t=G(c,s))||t.enumerable});return u};var M=(u,c,e)=>(e=u!=null?H(Z(u)):{},L(c||!u||!u.__esModule?b(e,"default",{value:u,enumerable:!0}):e,u)),Y=u=>L(b({},"__esModule",{value:!0}),u);var ne={};X(ne,{default:()=>v});module.exports=Y(ne);var a=require("obsidian"),h=M(require("fs")),k=M(require("path")),F="https://kjarni.ai/models",W={encoder:{filename:"encoder.kjq",url:`${F}/all-MiniLM-L6-v2-q8.kjq`,size:"22 MB"},reranker:{filename:"reranker.kjq",url:`${F}/ms-marco-MiniLM-L-6-v2-q8.kjq`,size:"22 MB"}},T=2,ee=3e3,te=5e3,_={chunkSize:1e3,chunkOverlap:200,searchLimit:10,rerankerEnabled:!0,debugLogging:!1};function se(u){return u.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function ie(u,c){if(c.length===0)return u;let e=c.map(s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),t=new RegExp(`(${e.join("|")})`,"gi");return u.replace(t,'<mark class="kjarni-highlight">$1</mark>')}var v=class extends a.Plugin{constructor(){super(...arguments);this.settings=_;this.pluginDir="";this.searchWorker=null;this.hasReranker=!1;this.indexReady=!1;this.indexing=!1;this.statusBarEl=null;this.nextId=1;this.searchPending=new Map;this.encoderWorkers=[];this.encoderPending=new Map;this.pendingUpdates=new Set;this.pendingDeletes=new Set;this.updateTimer=null;this.deleteTimer=null;this.wasmBytesCache=null;this.encoderBytesCache=null}async onload(){await this.loadSettings(),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.setText("");let e=this.app.vault.adapter.basePath;this.pluginDir=k.join(e,".obsidian","plugins","kjarni-search"),this.addCommand({id:"open-search",name:"Search vault",callback:()=>this.openSearch(),hotkeys:[{modifiers:["Mod","Shift"],key:"k"}]}),this.addCommand({id:"reindex-vault",name:"Reindex vault",callback:()=>this.reindexVault()}),this.addRibbonIcon("search","Kjarni Search",()=>this.openSearch()),this.addSettingTab(new R(this.app,this)),this.registerEvent(this.app.vault.on("modify",t=>{t instanceof a.TFile&&t.extension==="md"&&this.queueFileUpdate(t.path)})),this.registerEvent(this.app.vault.on("create",t=>{t instanceof a.TFile&&t.extension==="md"&&this.queueFileUpdate(t.path)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof a.TFile&&t.extension==="md"&&this.queueFileDelete(t.path)})),this.registerEvent(this.app.vault.on("rename",(t,s)=>{t instanceof a.TFile&&t.extension==="md"&&(this.queueFileDelete(s),this.queueFileUpdate(t.path))})),this.initializeAsync()}onunload(){var e;this.updateTimer&&clearTimeout(this.updateTimer),this.deleteTimer&&clearTimeout(this.deleteTimer),this.stopEncoderPool(),(e=this.searchWorker)==null||e.terminate(),this.searchWorker=null}createBlobWorker(e){let t=k.join(this.pluginDir,e),s=h.readFileSync(t,"utf8"),i=new Blob([s],{type:"application/javascript"}),n=URL.createObjectURL(i);return new Worker(n)}postToSearch(e,t){return new Promise((s,i)=>{if(!this.searchWorker){i(new Error("Search worker not started"));return}let n=this.nextId++;e.id=n,this.searchPending.set(n,{resolve:s,reject:i}),t?this.searchWorker.postMessage(e,t):this.searchWorker.postMessage(e)})}postToEncoder(e,t,s){return new Promise((i,n)=>{let r=this.nextId++;t.id=r,this.encoderPending.set(r,{resolve:i,reject:n}),s?e.postMessage(t,s):e.postMessage(t)})}async setWorkerLogging(e){try{await this.postToSearch({type:"set_logging",enabled:e})}catch(t){}}startSearchWorker(){this.searchWorker=this.createBlobWorker("worker.js"),this.searchWorker.onmessage=e=>{let t=e.data;if(t.id&&this.searchPending.has(t.id)){let{resolve:s,reject:i}=this.searchPending.get(t.id);this.searchPending.delete(t.id),t.type==="error"?i(new Error(t.error)):s(t);return}t.type==="error"&&console.error("Kjarni search worker:",t.error)},this.searchWorker.onerror=e=>{console.error("Kjarni search worker crashed:",e),new a.Notice(`Kjarni: Worker error \u2014 ${e.message}`)}}async startEncoderPool(){if(!this.wasmBytesCache||!this.encoderBytesCache)throw new Error("WASM/encoder bytes not loaded");this.encoderWorkers=[];for(let e=0;e<T;e++){let t=this.createBlobWorker("encoder-worker.js");t.onmessage=n=>{let r=n.data;if(r.type!=="encode_progress"&&r.id&&this.encoderPending.has(r.id)){let{resolve:o,reject:f}=this.encoderPending.get(r.id);this.encoderPending.delete(r.id),r.type==="error"?f(new Error(r.error)):o(r)}},t.onerror=n=>{console.error(`Kjarni encoder worker ${e} crashed:`,n)};let s=this.wasmBytesCache.slice(0),i=this.encoderBytesCache.slice(0);await this.postToEncoder(t,{type:"init",wasmBytes:s,encoderBytes:i},[s,i]),this.settings.debugLogging&&await this.postToEncoder(t,{type:"set_logging",enabled:!0}),this.encoderWorkers.push(t)}}stopEncoderPool(){for(let e of this.encoderWorkers)e.terminate();this.encoderWorkers=[]}async downloadModel(e,t){var i;let s=k.join(t,e.filename);if(h.existsSync(s))return s;(i=this.statusBarEl)==null||i.setText(`Kjarni: downloading ${e.filename} (${e.size})...`),new a.Notice(`Kjarni: Downloading ${e.filename} (${e.size})...`);try{let n=await(0,a.requestUrl)({url:e.url,method:"GET"});return h.mkdirSync(t,{recursive:!0}),h.writeFileSync(s,Buffer.from(n.arrayBuffer)),s}catch(n){throw h.existsSync(s)&&h.unlinkSync(s),new Error(`Failed to download ${e.filename}: ${n}`)}}async ensureModels(){var t;let e=k.join(this.pluginDir,"models");try{return await this.downloadModel(W.encoder,e),this.settings.rerankerEnabled&&await this.downloadModel(W.reranker,e),(t=this.statusBarEl)==null||t.setText(""),!0}catch(s){return console.error("Kjarni: Model download failed:",s),new a.Notice(`Kjarni: ${s}`,1e4),!1}}async initializeAsync(){var e,t,s;try{if(!this.checkFiles()||!await this.ensureModels())return;(e=this.statusBarEl)==null||e.setText("Kjarni: loading engine...");let i=h.readFileSync(k.join(this.pluginDir,"pkg","kjarni_wasm_bg.wasm")),n=h.readFileSync(k.join(this.pluginDir,"models","encoder.kjq"));this.wasmBytesCache=i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength),this.encoderBytesCache=n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength),this.startSearchWorker();let r=null;if(this.settings.rerankerEnabled){let d=k.join(this.pluginDir,"models","reranker.kjq");if(h.existsSync(d)){let x=h.readFileSync(d);r=x.buffer.slice(x.byteOffset,x.byteOffset+x.byteLength)}}let o=null,f=0,p=k.join(this.pluginDir,"index.idx");if(h.existsSync(p)){let d=h.readFileSync(p);o=d.buffer.slice(d.byteOffset,d.byteOffset+d.byteLength),f=h.statSync(p).mtimeMs}let w=[this.wasmBytesCache.slice(0),this.encoderBytesCache.slice(0)],m={type:"init",wasmBytes:w[0],encoderBytes:w[1]};if(r){let d=r.slice(0);m.rerankerBytes=d,w.push(d)}if(o){let d=o.slice(0);m.indexBytes=d,w.push(d)}let g=await this.postToSearch(m,w);this.hasReranker=g.hasReranker,await this.setWorkerLogging(this.settings.debugLogging),g.hasIndex?(this.indexReady=!0,(t=this.statusBarEl)==null||t.setText(`Kjarni: ${g.docCount} chunks`),new a.Notice(`Kjarni: Loaded index (${g.docCount} chunks)`),await this.catchUpChangedFiles(f)):await this.buildFullIndex()}catch(i){console.error("Kjarni: Initialization failed:",i),new a.Notice(`Kjarni: Failed to initialize \u2014 ${i}`),(s=this.statusBarEl)==null||s.setText("Kjarni: init failed")}}checkFiles(){let e=k.join(this.pluginDir,"pkg","kjarni_wasm_bg.wasm"),t=k.join(this.pluginDir,"worker.js"),s=k.join(this.pluginDir,"encoder-worker.js"),i=[];return h.existsSync(e)||i.push("pkg/kjarni_wasm_bg.wasm"),h.existsSync(t)||i.push("worker.js"),h.existsSync(s)||i.push("encoder-worker.js"),i.length>0?(new a.Notice(`Kjarni: Missing files:
${i.join(`
`)}

Reinstall the plugin.`,1e4),!1):!0}async buildFullIndex(){var e,t,s,i,n,r,o,f;if(!this.indexing){this.indexing=!0;try{let p=Date.now(),w=this.app.vault.getMarkdownFiles().sort((l,y)=>l.path.localeCompare(y.path));(e=this.statusBarEl)==null||e.setText(`Kjarni: reading ${w.length} files...`);let m=[];for(let l of w){let y=await this.app.vault.cachedRead(l);y.trim().length>0&&m.push({text:y,path:l.path})}let g=m.length;if(g===0){(t=this.statusBarEl)==null||t.setText("Kjarni: no files to index");return}(s=this.statusBarEl)==null||s.setText(`Kjarni: starting ${T} encoder workers...`),await this.startEncoderPool();let d=Array.from({length:T},()=>[]);for(let l=0;l<m.length;l++)d[l%T].push(m[l]);let x=new Array(T).fill(0),S=0,C=l=>{var P;let y=l.data;if(y.type==="encode_progress"){x[y.workerId]=y.indexed;let K=x.reduce((N,V)=>N+V,0),A=((Date.now()-p)/1e3).toFixed(0),z=(K/(Date.now()-p)*1e3).toFixed(1);(P=this.statusBarEl)==null||P.setText(`Kjarni: encoding ${K}/${g} files \xB7 ${A}s \xB7 ${z} files/s`)}};for(let l of this.encoderWorkers)l.addEventListener("message",C);(i=this.statusBarEl)==null||i.setText(`Kjarni: encoding 0/${g} files...`);let I=d.map((l,y)=>l.length===0?Promise.resolve({chunks:[],skipped:0}):this.postToEncoder(this.encoderWorkers[y],{type:"encode_batch",files:l,workerId:y})),U=await Promise.all(I);for(let l of this.encoderWorkers)l.removeEventListener("message",C);this.stopEncoderPool();let E=[],B=0;for(let l of U)l.chunks&&(E=E.concat(l.chunks)),B+=l.skipped||0;S=E.length,(n=this.statusBarEl)==null||n.setText(`Kjarni: building index from ${S} chunks...`),await this.postToSearch({type:"build_start"});let D=1e3;for(let l=0;l<E.length;l+=D){let y=E.slice(l,l+D);await this.postToSearch({type:"add_encoded_chunks",chunks:y}),(r=this.statusBarEl)==null||r.setText(`Kjarni: indexing ${Math.min(l+D,E.length)}/${S} chunks...`)}let j=await this.postToSearch({type:"build_finish"});if(j.indexBytes){let l=k.join(this.pluginDir,"index.idx");h.writeFileSync(l,Buffer.from(j.indexBytes))}this.indexReady=!0;let q=((Date.now()-p)/1e3).toFixed(1),O=B>0?` (${B} skipped)`:"";(o=this.statusBarEl)==null||o.setText(`Kjarni: ${j.docCount} chunks \xB7 ${g} files`),new a.Notice(`Kjarni: Indexed ${j.docCount} chunks from ${g} files in ${q}s${O}`)}catch(p){console.error("Kjarni: Indexing failed:",p),new a.Notice(`Kjarni: Indexing failed \u2014 ${p}`),(f=this.statusBarEl)==null||f.setText("Kjarni: indexing failed"),this.stopEncoderPool()}finally{this.indexing=!1}}}async catchUpChangedFiles(e){var n;let t=this.app.vault.getMarkdownFiles(),s=t.filter(r=>r.stat.mtime>e);if(s.length===0)return;if(s.length>t.length*.5){new a.Notice(`Kjarni: ${s.length} files changed \u2014 rebuilding...`),await this.buildFullIndex();return}(n=this.statusBarEl)==null||n.setText(`Kjarni: updating ${s.length} changed files...`);let i=0;for(let r of s)try{let o=await this.app.vault.cachedRead(r);await this.postToSearch({type:"update_file",text:o,path:r.path}),i++}catch(o){console.warn(`Kjarni: Failed to update ${r.path}: ${o}`)}i>0&&(await this.requestSaveIndex(),new a.Notice(`Kjarni: Updated ${i} changed files`))}queueFileUpdate(e){this.indexReady&&(this.pendingDeletes.delete(e),this.pendingUpdates.add(e),this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this.flushUpdates(),ee))}queueFileDelete(e){this.indexReady&&(this.pendingUpdates.delete(e),this.pendingDeletes.add(e),this.deleteTimer&&clearTimeout(this.deleteTimer),this.deleteTimer=setTimeout(()=>this.flushDeletes(),te))}async flushUpdates(){var i;if(this.pendingUpdates.size===0)return;let e=[...this.pendingUpdates];this.pendingUpdates.clear();let t=0,s=0;for(let n of e){let r=this.app.vault.getAbstractFileByPath(n);if(r instanceof a.TFile)try{let o=await this.app.vault.cachedRead(r);s=(await this.postToSearch({type:"update_file",text:o,path:n})).docCount,t++}catch(o){console.warn(`Kjarni: Failed to update ${n}: ${o}`)}}t>0&&(this.requestSaveIndex(),(i=this.statusBarEl)==null||i.setText(`Kjarni: ${s} chunks \xB7 updated ${t} files`),setTimeout(()=>{var n;(n=this.statusBarEl)==null||n.setText(`Kjarni: ${s} chunks`)},3e3))}async flushDeletes(){var s;if(this.pendingDeletes.size===0)return;let e=[...this.pendingDeletes];this.pendingDeletes.clear();let t=0;for(let i of e)try{t=(await this.postToSearch({type:"remove_file",path:i})).docCount}catch(n){console.warn(`Kjarni: Failed to remove ${i}: ${n}`)}this.requestSaveIndex(),(s=this.statusBarEl)==null||s.setText(`Kjarni: ${t} chunks`)}async requestSaveIndex(){var e;try{let t=await this.postToSearch({type:"save_index"});if(t.indexBytes){let s=k.join(this.pluginDir,"index.idx");h.writeFileSync(s,Buffer.from(t.indexBytes))}(e=this.statusBarEl)==null||e.setText(`Kjarni: ${t.docCount} chunks`)}catch(t){console.error("Kjarni: Failed to save index:",t)}}async reindexVault(){if(this.indexing){new a.Notice("Kjarni: Already indexing...");return}this.pendingUpdates.clear(),this.pendingDeletes.clear(),this.updateTimer&&clearTimeout(this.updateTimer),this.deleteTimer&&clearTimeout(this.deleteTimer),await this.buildFullIndex()}openSearch(){if(!this.indexReady){new a.Notice("Kjarni: Index not ready. Please wait for indexing to complete.");return}new $(this.app,this).open()}async doSearch(e,t){if(!e.trim())return[];try{return(await this.postToSearch({type:"search",query:e,limit:t})).results||[]}catch(s){return console.error("Kjarni: Search failed:",s),[]}}async doRerank(e,t,s){if(!this.hasReranker||t.length===0)return[];try{return(await this.postToSearch({type:"rerank",query:e,docs:t,limit:s})).results||[]}catch(i){return console.error("Kjarni: Rerank failed:",i),[]}}async loadSettings(){this.settings=Object.assign({},_,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},$=class extends a.Modal{constructor(e,t){super(e);this.inputEl=null;this.resultsEl=null;this.statusEl=null;this.debounceTimer=null;this.searchVersion=0;this.lastDisplayed=[];this.rerankTimer=null;this.plugin=t}onOpen(){let{contentEl:e,modalEl:t}=this;t.addClass("kjarni-search-modal");let s=e.createDiv({cls:"kjarni-header"}),i=s.createEl("span",{cls:"kjarni-icon"});i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',this.inputEl=s.createEl("input",{cls:"kjarni-input",attr:{type:"text",placeholder:"Search your vault...",spellcheck:"false"}}),s.createEl("span",{cls:"kjarni-kbd",text:"esc"}),this.resultsEl=e.createDiv({cls:"kjarni-results"}),this.statusEl=e.createDiv({cls:"kjarni-status"}),this.inputEl.addEventListener("input",()=>{this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>this.runSearch(),300)}),this.inputEl.addEventListener("keydown",n=>{n.key==="Escape"?this.close():n.key==="Enter"&&this.openResult(0)}),this.inputEl.focus()}async runSearch(){var o,f;let e=(f=(o=this.inputEl)==null?void 0:o.value)==null?void 0:f.trim();if(!e||e.length<3||!this.resultsEl){this.resultsEl&&this.resultsEl.empty(),this.statusEl&&(this.statusEl.textContent="");return}this.searchVersion++;let t=this.searchVersion;this.rerankTimer&&clearTimeout(this.rerankTimer);let s=performance.now(),i=await this.plugin.doSearch(e,this.plugin.settings.searchLimit*2),n=performance.now()-s;if(this.searchVersion!==t)return;let r=i.slice(0,this.plugin.settings.searchLimit);this.lastDisplayed=r,this.renderResults(r),this.statusEl&&(this.statusEl.textContent=`${r.length} results \xB7 ${n.toFixed(0)}ms`,this.statusEl.removeClass("kjarni-refining")),this.plugin.hasReranker&&r.length>0&&e.length>=5&&(this.rerankTimer=setTimeout(()=>{this.doRerank(e,r,t,n)},1e3))}async doRerank(e,t,s,i){if(this.searchVersion!==s)return;this.statusEl&&(this.statusEl.textContent=`${t.length} results \xB7 ${i.toFixed(0)}ms \xB7 refining...`,this.statusEl.addClass("kjarni-refining"));let n=t.slice(0,5).map(p=>p.text),r=performance.now(),o=await this.plugin.doRerank(e,n,5),f=performance.now()-r;if(this.searchVersion===s){if(o.length>0){let p=o.map(g=>t[g.index]),w=new Set(o.map(g=>g.index)),m=t.filter((g,d)=>d>=5||!w.has(d));this.lastDisplayed=[...p,...m],this.renderResults(this.lastDisplayed)}this.statusEl&&(this.statusEl.textContent=`${t.length} results \xB7 ${i.toFixed(0)}ms search \xB7 ${f.toFixed(0)}ms rerank \xB7 refined`,this.statusEl.removeClass("kjarni-refining"),this.statusEl.addClass("kjarni-refined"),setTimeout(()=>{var p;return(p=this.statusEl)==null?void 0:p.removeClass("kjarni-refined")},2e3))}}renderResults(e){var n,r;if(!this.resultsEl)return;if(this.resultsEl.empty(),e.length===0){this.resultsEl.createDiv({cls:"kjarni-empty",text:"No results found"});return}let s=(((r=(n=this.inputEl)==null?void 0:n.value)==null?void 0:r.trim())||"").toLowerCase().split(/\s+/).filter(o=>o.length>=2),i=Math.max(...e.map(o=>o.score),.001);e.forEach((o,f)=>{let p=o.text.length>200?o.text.slice(0,200)+"\u2026":o.text,w=Math.round(o.score/i*100),m=this.resultsEl.createDiv({cls:"kjarni-result"});m.addEventListener("click",()=>this.openResult(f));let g=m.createDiv({cls:"kjarni-result-title"});g.createEl("span",{text:o.source.replace(/\.md$/,"")});let d=g.createEl("span",{cls:"kjarni-score"});d.textContent=`${w}%`;let x=m.createDiv({cls:"kjarni-result-text"});x.innerHTML=ie(se(p),s)})}openResult(e){let t=this.lastDisplayed[e];if(!t)return;this.app.vault.getAbstractFileByPath(t.source)instanceof a.TFile&&(this.app.workspace.openLinkText(t.source,"",!1),this.close())}onClose(){this.searchVersion++,this.debounceTimer&&clearTimeout(this.debounceTimer),this.rerankTimer&&clearTimeout(this.rerankTimer),this.contentEl.empty()}},R=class extends a.PluginSettingTab{constructor(c,e){super(c,e),this.plugin=e}display(){let{containerEl:c}=this;c.empty(),c.createEl("h2",{text:"Kjarni Search"}),new a.Setting(c).setName("Search results limit").setDesc("Maximum number of results to show").addSlider(e=>e.setLimits(5,30,5).setValue(this.plugin.settings.searchLimit).setDynamicTooltip().onChange(async t=>{this.plugin.settings.searchLimit=t,await this.plugin.saveSettings()})),new a.Setting(c).setName("Reranker").setDesc("Use cross-encoder reranking for better result quality").addToggle(e=>e.setValue(this.plugin.settings.rerankerEnabled).onChange(async t=>{this.plugin.settings.rerankerEnabled=t,await this.plugin.saveSettings()})),new a.Setting(c).setName("Chunk size").setDesc("Maximum characters per chunk when indexing (default 1000)").addText(e=>e.setValue(String(this.plugin.settings.chunkSize)).onChange(async t=>{let s=parseInt(t);!isNaN(s)&&s>100&&(this.plugin.settings.chunkSize=s,await this.plugin.saveSettings())})),new a.Setting(c).setName("Reindex vault").setDesc("Rebuild the search index from scratch").addButton(e=>e.setButtonText("Reindex").onClick(async()=>{await this.plugin.reindexVault()})),c.createEl("h3",{text:"Developer"}),new a.Setting(c).setName("Debug logging").setDesc("Log detailed timing info to the developer console. Requires Obsidian restart.").addToggle(e=>e.setValue(this.plugin.settings.debugLogging).onChange(async t=>{this.plugin.settings.debugLogging=t,await this.plugin.saveSettings(),await this.plugin.setWorkerLogging(t)}))}};
