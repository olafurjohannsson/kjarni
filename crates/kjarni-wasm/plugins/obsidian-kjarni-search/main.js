var H=Object.create;var B=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var X=(u,h)=>{for(var t in h)B(u,t,{get:h[t],enumerable:!0})},M=(u,h,t,e)=>{if(h&&typeof h=="object"||typeof h=="function")for(let s of J(h))!Q.call(u,s)&&s!==t&&B(u,s,{get:()=>h[s],enumerable:!(e=G(h,s))||e.enumerable});return u};var L=(u,h,t)=>(t=u!=null?H(Z(u)):{},M(h||!u||!u.__esModule?B(t,"default",{value:u,enumerable:!0}):t,u)),Y=u=>M(B({},"__esModule",{value:!0}),u);var se={};X(se,{default:()=>D});module.exports=Y(se);var a=require("obsidian"),l=L(require("fs")),p=L(require("path")),_="https://kjarni.ai/models",W={encoder:{filename:"encoder.kjq",url:`${_}/all-MiniLM-L6-v2-q8.kjq`,size:"22 MB"},reranker:{filename:"reranker.kjq",url:`${_}/ms-marco-MiniLM-L-6-v2-q8.kjq`,size:"22 MB"}},v=4,ee=3e3,te=5e3,I={chunkSize:1e3,chunkOverlap:200,searchLimit:10,rerankerEnabled:!0},D=class extends a.Plugin{constructor(){super(...arguments);this.settings=I;this.pluginDir="";this.searchWorker=null;this.hasReranker=!1;this.indexReady=!1;this.indexing=!1;this.statusBarEl=null;this.nextId=1;this.searchPending=new Map;this.encoderWorkers=[];this.encoderPending=new Map;this.pendingUpdates=new Set;this.pendingDeletes=new Set;this.updateTimer=null;this.deleteTimer=null;this.wasmBytesCache=null;this.encoderBytesCache=null}async onload(){await this.loadSettings(),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.setText("");let t=this.app.vault.adapter.basePath;this.pluginDir=p.join(t,".obsidian","plugins","kjarni-search"),this.addCommand({id:"open-search",name:"Search vault",callback:()=>this.openSearch(),hotkeys:[{modifiers:["Mod","Shift"],key:"k"}]}),this.addCommand({id:"reindex-vault",name:"Reindex vault",callback:()=>this.reindexVault()}),this.addRibbonIcon("search","Kjarni Search",()=>this.openSearch()),this.addSettingTab(new P(this.app,this)),this.registerEvent(this.app.vault.on("modify",e=>{e instanceof a.TFile&&e.extension==="md"&&this.queueFileUpdate(e.path)})),this.registerEvent(this.app.vault.on("create",e=>{e instanceof a.TFile&&e.extension==="md"&&this.queueFileUpdate(e.path)})),this.registerEvent(this.app.vault.on("delete",e=>{e instanceof a.TFile&&e.extension==="md"&&this.queueFileDelete(e.path)})),this.registerEvent(this.app.vault.on("rename",(e,s)=>{e instanceof a.TFile&&e.extension==="md"&&(this.queueFileDelete(s),this.queueFileUpdate(e.path))})),this.initializeAsync()}onunload(){var t;this.updateTimer&&clearTimeout(this.updateTimer),this.deleteTimer&&clearTimeout(this.deleteTimer),this.stopEncoderPool(),(t=this.searchWorker)==null||t.terminate(),this.searchWorker=null}createBlobWorker(t){let e=p.join(this.pluginDir,t),s=l.readFileSync(e,"utf8"),i=new Blob([s],{type:"application/javascript"}),n=URL.createObjectURL(i);return new Worker(n)}postToSearch(t,e){return new Promise((s,i)=>{if(!this.searchWorker){i(new Error("Search worker not started"));return}let n=this.nextId++;t.id=n,this.searchPending.set(n,{resolve:s,reject:i}),e?this.searchWorker.postMessage(t,e):this.searchWorker.postMessage(t)})}postToEncoder(t,e,s){return new Promise((i,n)=>{let r=this.nextId++;e.id=r,this.encoderPending.set(r,{resolve:i,reject:n}),s?t.postMessage(e,s):t.postMessage(e)})}startSearchWorker(){this.searchWorker=this.createBlobWorker("worker.js"),this.searchWorker.onmessage=t=>{let e=t.data;if(e.id&&this.searchPending.has(e.id)){let{resolve:s,reject:i}=this.searchPending.get(e.id);this.searchPending.delete(e.id),e.type==="error"?i(new Error(e.error)):s(e);return}e.type==="error"&&console.error("Kjarni search worker:",e.error)},this.searchWorker.onerror=t=>{console.error("Kjarni search worker crashed:",t),new a.Notice(`Kjarni: Worker error \u2014 ${t.message}`)}}async startEncoderPool(){if(!this.wasmBytesCache||!this.encoderBytesCache)throw new Error("WASM/encoder bytes not loaded");this.encoderWorkers=[];for(let t=0;t<v;t++){let e=this.createBlobWorker("encoder-worker.js");e.onmessage=n=>{let r=n.data;if(r.type!=="encode_progress"&&r.id&&this.encoderPending.has(r.id)){let{resolve:d,reject:k}=this.encoderPending.get(r.id);this.encoderPending.delete(r.id),r.type==="error"?k(new Error(r.error)):d(r)}},e.onerror=n=>{console.error(`Kjarni encoder worker ${t} crashed:`,n)};let s=this.wasmBytesCache.slice(0),i=this.encoderBytesCache.slice(0);await this.postToEncoder(e,{type:"init",wasmBytes:s,encoderBytes:i},[s,i]),this.encoderWorkers.push(e)}}stopEncoderPool(){for(let t of this.encoderWorkers)t.terminate();this.encoderWorkers=[]}async downloadModel(t,e){var i;let s=p.join(e,t.filename);if(l.existsSync(s))return s;(i=this.statusBarEl)==null||i.setText(`Kjarni: downloading ${t.filename} (${t.size})...`),new a.Notice(`Kjarni: Downloading ${t.filename} (${t.size})...`);try{let n=await(0,a.requestUrl)({url:t.url,method:"GET"});return l.mkdirSync(e,{recursive:!0}),l.writeFileSync(s,Buffer.from(n.arrayBuffer)),s}catch(n){throw l.existsSync(s)&&l.unlinkSync(s),new Error(`Failed to download ${t.filename}: ${n}`)}}async ensureModels(){var e;let t=p.join(this.pluginDir,"models");try{return await this.downloadModel(W.encoder,t),this.settings.rerankerEnabled&&await this.downloadModel(W.reranker,t),(e=this.statusBarEl)==null||e.setText(""),!0}catch(s){return console.error("Kjarni: Model download failed:",s),new a.Notice(`Kjarni: ${s}`,1e4),!1}}async initializeAsync(){var t,e,s;try{if(!this.checkFiles()||!await this.ensureModels())return;(t=this.statusBarEl)==null||t.setText("Kjarni: loading engine...");let i=l.readFileSync(p.join(this.pluginDir,"pkg","kjarni_wasm_bg.wasm")),n=l.readFileSync(p.join(this.pluginDir,"models","encoder.kjq"));this.wasmBytesCache=i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength),this.encoderBytesCache=n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength),this.startSearchWorker();let r=null;if(this.settings.rerankerEnabled){let c=p.join(this.pluginDir,"models","reranker.kjq");if(l.existsSync(c)){let w=l.readFileSync(c);r=w.buffer.slice(w.byteOffset,w.byteOffset+w.byteLength)}}let d=null,k=0,g=p.join(this.pluginDir,"index.idx");if(l.existsSync(g)){let c=l.readFileSync(g);d=c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength),k=l.statSync(g).mtimeMs}let x=[this.wasmBytesCache.slice(0),this.encoderBytesCache.slice(0)],m={type:"init",wasmBytes:x[0],encoderBytes:x[1]};if(r){let c=r.slice(0);m.rerankerBytes=c,x.push(c)}if(d){let c=d.slice(0);m.indexBytes=c,x.push(c)}let y=await this.postToSearch(m,x);this.hasReranker=y.hasReranker,y.hasIndex?(this.indexReady=!0,(e=this.statusBarEl)==null||e.setText(`Kjarni: ${y.docCount} chunks`),new a.Notice(`Kjarni: Loaded index (${y.docCount} chunks)`),await this.catchUpChangedFiles(k)):await this.buildFullIndex()}catch(i){console.error("Kjarni: Initialization failed:",i),new a.Notice(`Kjarni: Failed to initialize \u2014 ${i}`),(s=this.statusBarEl)==null||s.setText("Kjarni: init failed")}}checkFiles(){let t=p.join(this.pluginDir,"pkg","kjarni_wasm_bg.wasm"),e=p.join(this.pluginDir,"worker.js"),s=p.join(this.pluginDir,"encoder-worker.js"),i=[];return l.existsSync(t)||i.push("pkg/kjarni_wasm_bg.wasm"),l.existsSync(e)||i.push("worker.js"),l.existsSync(s)||i.push("encoder-worker.js"),i.length>0?(new a.Notice(`Kjarni: Missing files:
${i.join(`
`)}

Reinstall the plugin.`,1e4),!1):!0}async buildFullIndex(){var t,e,s,i,n,r,d,k;if(!this.indexing){this.indexing=!0;try{let g=Date.now(),x=this.app.vault.getMarkdownFiles().sort((o,f)=>o.path.localeCompare(f.path));(t=this.statusBarEl)==null||t.setText(`Kjarni: reading ${x.length} files...`);let m=[];for(let o of x){let f=await this.app.vault.cachedRead(o);f.trim().length>0&&m.push({text:f,path:o.path})}let y=m.length;if(y===0){(e=this.statusBarEl)==null||e.setText("Kjarni: no files to index");return}(s=this.statusBarEl)==null||s.setText(`Kjarni: starting ${v} encoder workers...`),await this.startEncoderPool();let c=Array.from({length:v},()=>[]);for(let o=0;o<m.length;o++)c[o%v].push(m[o]);let w=new Array(v).fill(0),T=0,E=o=>{var K;let f=o.data;if(f.type==="encode_progress"){w[f.workerId]=f.indexed;let F=w.reduce((N,V)=>N+V,0),O=((Date.now()-g)/1e3).toFixed(0),z=(F/(Date.now()-g)*1e3).toFixed(1);(K=this.statusBarEl)==null||K.setText(`Kjarni: encoding ${F}/${y} files \xB7 ${O}s \xB7 ${z} files/s`)}};for(let o of this.encoderWorkers)o.addEventListener("message",E);(i=this.statusBarEl)==null||i.setText(`Kjarni: encoding 0/${y} files...`);let b=c.map((o,f)=>o.length===0?Promise.resolve({chunks:[],skipped:0}):this.postToEncoder(this.encoderWorkers[f],{type:"encode_batch",files:o,workerId:f})),U=await Promise.all(b);for(let o of this.encoderWorkers)o.removeEventListener("message",E);this.stopEncoderPool();let j=[],R=0;for(let o of U)o.chunks&&(j=j.concat(o.chunks)),R+=o.skipped||0;T=j.length,(n=this.statusBarEl)==null||n.setText(`Kjarni: building index from ${T} chunks...`),await this.postToSearch({type:"build_start"});let $=1e3;for(let o=0;o<j.length;o+=$){let f=j.slice(o,o+$);await this.postToSearch({type:"add_encoded_chunks",chunks:f}),(r=this.statusBarEl)==null||r.setText(`Kjarni: indexing ${Math.min(o+$,j.length)}/${T} chunks...`)}let S=await this.postToSearch({type:"build_finish"});if(S.indexBytes){let o=p.join(this.pluginDir,"index.idx");l.writeFileSync(o,Buffer.from(S.indexBytes))}this.indexReady=!0;let q=((Date.now()-g)/1e3).toFixed(1),A=R>0?` (${R} skipped)`:"";(d=this.statusBarEl)==null||d.setText(`Kjarni: ${S.docCount} chunks \xB7 ${y} files`),new a.Notice(`Kjarni: Indexed ${S.docCount} chunks from ${y} files in ${q}s${A}`)}catch(g){console.error("Kjarni: Indexing failed:",g),new a.Notice(`Kjarni: Indexing failed \u2014 ${g}`),(k=this.statusBarEl)==null||k.setText("Kjarni: indexing failed"),this.stopEncoderPool()}finally{this.indexing=!1}}}async catchUpChangedFiles(t){var n;let e=this.app.vault.getMarkdownFiles(),s=e.filter(r=>r.stat.mtime>t);if(s.length===0)return;if(s.length>e.length*.5){new a.Notice(`Kjarni: ${s.length} files changed \u2014 rebuilding...`),await this.buildFullIndex();return}(n=this.statusBarEl)==null||n.setText(`Kjarni: updating ${s.length} changed files...`);let i=0;for(let r of s)try{let d=await this.app.vault.cachedRead(r);await this.postToSearch({type:"update_file",text:d,path:r.path}),i++}catch(d){console.warn(`Kjarni: Failed to update ${r.path}: ${d}`)}i>0&&(await this.requestSaveIndex(),new a.Notice(`Kjarni: Updated ${i} changed files`))}queueFileUpdate(t){this.indexReady&&(this.pendingDeletes.delete(t),this.pendingUpdates.add(t),this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this.flushUpdates(),ee))}queueFileDelete(t){this.indexReady&&(this.pendingUpdates.delete(t),this.pendingDeletes.add(t),this.deleteTimer&&clearTimeout(this.deleteTimer),this.deleteTimer=setTimeout(()=>this.flushDeletes(),te))}async flushUpdates(){var i;if(this.pendingUpdates.size===0)return;let t=[...this.pendingUpdates];this.pendingUpdates.clear();let e=0,s=0;for(let n of t){let r=this.app.vault.getAbstractFileByPath(n);if(r instanceof a.TFile)try{let d=await this.app.vault.cachedRead(r);s=(await this.postToSearch({type:"update_file",text:d,path:n})).docCount,e++}catch(d){console.warn(`Kjarni: Failed to update ${n}: ${d}`)}}e>0&&(this.requestSaveIndex(),(i=this.statusBarEl)==null||i.setText(`Kjarni: ${s} chunks \xB7 updated ${e} files`),setTimeout(()=>{var n;(n=this.statusBarEl)==null||n.setText(`Kjarni: ${s} chunks`)},3e3))}async flushDeletes(){var s;if(this.pendingDeletes.size===0)return;let t=[...this.pendingDeletes];this.pendingDeletes.clear();let e=0;for(let i of t)try{e=(await this.postToSearch({type:"remove_file",path:i})).docCount}catch(n){console.warn(`Kjarni: Failed to remove ${i}: ${n}`)}this.requestSaveIndex(),(s=this.statusBarEl)==null||s.setText(`Kjarni: ${e} chunks`)}async requestSaveIndex(){var t;try{let e=await this.postToSearch({type:"save_index"});if(e.indexBytes){let s=p.join(this.pluginDir,"index.idx");l.writeFileSync(s,Buffer.from(e.indexBytes))}(t=this.statusBarEl)==null||t.setText(`Kjarni: ${e.docCount} chunks`)}catch(e){console.error("Kjarni: Failed to save index:",e)}}async reindexVault(){if(this.indexing){new a.Notice("Kjarni: Already indexing...");return}this.pendingUpdates.clear(),this.pendingDeletes.clear(),this.updateTimer&&clearTimeout(this.updateTimer),this.deleteTimer&&clearTimeout(this.deleteTimer),await this.buildFullIndex()}openSearch(){if(!this.indexReady){new a.Notice("Kjarni: Index not ready. Please wait for indexing to complete.");return}new C(this.app,this).open()}async doSearch(t,e){if(!t.trim())return[];try{return(await this.postToSearch({type:"search",query:t,limit:e})).results||[]}catch(s){return console.error("Kjarni: Search failed:",s),[]}}async doRerank(t,e,s){if(!this.hasReranker||e.length===0)return[];try{return(await this.postToSearch({type:"rerank",query:t,docs:e,limit:s})).results||[]}catch(i){return console.error("Kjarni: Rerank failed:",i),[]}}async loadSettings(){this.settings=Object.assign({},I,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},C=class extends a.Modal{constructor(t,e){super(t);this.inputEl=null;this.resultsEl=null;this.statusEl=null;this.debounceTimer=null;this.searchVersion=0;this.lastDisplayed=[];this.plugin=e}onOpen(){let{contentEl:t,modalEl:e}=this;e.addClass("kjarni-search-modal");let s=t.createDiv({cls:"kjarni-header"}),i=s.createEl("span",{cls:"kjarni-icon"});i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',this.inputEl=s.createEl("input",{cls:"kjarni-input",attr:{type:"text",placeholder:"Search your vault...",spellcheck:"false"}}),s.createEl("span",{cls:"kjarni-kbd",text:"esc"}),this.resultsEl=t.createDiv({cls:"kjarni-results"}),this.statusEl=t.createDiv({cls:"kjarni-status"}),this.inputEl.addEventListener("input",()=>{this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>this.runSearch(),150)}),this.inputEl.addEventListener("keydown",n=>{n.key==="Escape"?this.close():n.key==="Enter"&&this.openResult(0)}),this.inputEl.focus()}async runSearch(){var d,k;let t=(k=(d=this.inputEl)==null?void 0:d.value)==null?void 0:k.trim();if(!t||!this.resultsEl){this.resultsEl&&this.resultsEl.empty(),this.statusEl&&(this.statusEl.textContent="");return}this.searchVersion++;let e=this.searchVersion,s=performance.now(),i=await this.plugin.doSearch(t,this.plugin.settings.searchLimit*2),n=performance.now()-s;if(this.searchVersion!==e)return;let r=i.slice(0,this.plugin.settings.searchLimit);if(this.lastDisplayed=r,this.renderResults(r),this.plugin.hasReranker&&r.length>0){this.statusEl&&(this.statusEl.textContent=`${r.length} results \xB7 ${n.toFixed(0)}ms \xB7 refining...`,this.statusEl.addClass("kjarni-refining"));let g=r.slice(0,5).map(c=>c.text),x=performance.now(),m=await this.plugin.doRerank(t,g,5),y=performance.now()-x;if(this.searchVersion!==e)return;if(m.length>0){let c=m.map(E=>r[E.index]),w=new Set(m.map(E=>E.index)),T=r.filter((E,b)=>b>=5||!w.has(b));this.lastDisplayed=[...c,...T],this.renderResults(this.lastDisplayed)}this.statusEl&&(this.statusEl.textContent=`${r.length} results \xB7 ${n.toFixed(0)}ms search \xB7 ${y.toFixed(0)}ms rerank \xB7 refined`,this.statusEl.removeClass("kjarni-refining"),this.statusEl.addClass("kjarni-refined"),setTimeout(()=>{var c;return(c=this.statusEl)==null?void 0:c.removeClass("kjarni-refined")},2e3))}else this.statusEl&&(this.statusEl.textContent=`${r.length} results \xB7 ${n.toFixed(0)}ms`,this.statusEl.removeClass("kjarni-refining"))}renderResults(t){if(this.resultsEl){if(this.resultsEl.empty(),t.length===0){this.resultsEl.createDiv({cls:"kjarni-empty",text:"No results found"});return}t.forEach((e,s)=>{let i=e.text.length>200?e.text.slice(0,200)+"...":e.text,n=this.resultsEl.createDiv({cls:"kjarni-result"});n.addEventListener("click",()=>this.openResult(s));let r=n.createDiv({cls:"kjarni-result-title"});r.createEl("span",{text:e.source.replace(/\.md$/,"")}),r.createEl("span",{cls:"kjarni-score",text:e.score.toFixed(3)}),n.createDiv({cls:"kjarni-result-text",text:i})})}}openResult(t){let e=this.lastDisplayed[t];if(!e)return;this.app.vault.getAbstractFileByPath(e.source)instanceof a.TFile&&(this.app.workspace.openLinkText(e.source,"",!1),this.close())}onClose(){this.searchVersion++,this.debounceTimer&&clearTimeout(this.debounceTimer),this.contentEl.empty()}},P=class extends a.PluginSettingTab{constructor(h,t){super(h,t),this.plugin=t}display(){let{containerEl:h}=this;h.empty(),h.createEl("h2",{text:"Kjarni Search"}),new a.Setting(h).setName("Search results limit").setDesc("Maximum number of results to show").addSlider(t=>t.setLimits(5,30,5).setValue(this.plugin.settings.searchLimit).setDynamicTooltip().onChange(async e=>{this.plugin.settings.searchLimit=e,await this.plugin.saveSettings()})),new a.Setting(h).setName("Reranker").setDesc("Use cross-encoder reranking for better result quality").addToggle(t=>t.setValue(this.plugin.settings.rerankerEnabled).onChange(async e=>{this.plugin.settings.rerankerEnabled=e,await this.plugin.saveSettings()})),new a.Setting(h).setName("Chunk size").setDesc("Maximum characters per chunk when indexing (default 1000)").addText(t=>t.setValue(String(this.plugin.settings.chunkSize)).onChange(async e=>{let s=parseInt(e);!isNaN(s)&&s>100&&(this.plugin.settings.chunkSize=s,await this.plugin.saveSettings())})),new a.Setting(h).setName("Reindex vault").setDesc("Rebuild the search index from scratch").addButton(t=>t.setButtonText("Reindex").onClick(async()=>{await this.plugin.reindexVault()}))}};
